import {Web3Driver} from "@orbs-network/orbs-ethereum-contracts-v2";
import Web3 from "web3";
import * as _ from "lodash";
import {bn} from "./helpers";
import {ContractRegistryContract} from "@orbs-network/orbs-ethereum-contracts-v2/typings/contract-registry-contract";
import {compiledContracts} from "@orbs-network/orbs-ethereum-contracts-v2/release/compiled-contracts";
import {ProtocolWalletContract} from "@orbs-network/orbs-ethereum-contracts-v2/typings/protocol-wallet-contract";

const readline = require("readline-sync");

const CONTRACT_REGISTRY_ADDR = "0x5454223e3078Db87e55a15bE541cc925f3702eB0";
const OLD_STAKING_REWARDS_ADDR = "0x281e714ee8bFD7208B07205fb93d7C9298f3a807";
const OLD_FEES_AND_BOOTSTRAP_REWARDS_ADDR = "0xaa5f5f7D59aEBEbe90b5e2ac93F87Df639E5152a";
const OLD_STAKING_REWARDS_ABI = [{"inputs":[{"internalType":"contract IContractRegistry","name":"_contractRegistry","type":"address"},{"internalType":"address","name":"_registryAdmin","type":"address"},{"internalType":"contract IERC20","name":"_erc20","type":"address"},{"internalType":"uint256","name":"annualRateInPercentMille","type":"uint256"},{"internalType":"uint256","name":"annualCap","type":"uint256"},{"internalType":"uint32","name":"defaultDelegatorsStakingRewardsPercentMille","type":"uint32"},{"internalType":"uint32","name":"maxDelegatorsStakingRewardsPercentMille","type":"uint32"},{"internalType":"contract IStakingRewards","name":"previousRewardsContract","type":"address"},{"internalType":"address[]","name":"guardiansToMigrate","type":"address[]"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"annualRateInPercentMille","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"annualCap","type":"uint256"}],"name":"AnnualStakingRewardsRateChanged","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"addr","type":"address"}],"name":"ContractRegistryAddressUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint32","name":"defaultDelegatorsStakingRewardsPercentMille","type":"uint32"}],"name":"DefaultDelegatorsStakingRewardsChanged","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"delegator","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"totalAwarded","type":"uint256"},{"indexed":false,"internalType":"address","name":"guardian","type":"address"},{"indexed":false,"internalType":"uint256","name":"delegatorRewardsPerToken","type":"uint256"}],"name":"DelegatorStakingRewardsAssigned","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"addr","type":"address"}],"name":"EmergencyWithdrawal","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"guardian","type":"address"},{"indexed":false,"internalType":"uint256","name":"delegatorsStakingRewardsPercentMille","type":"uint256"}],"name":"GuardianDelegatorsStakingRewardsPercentMilleUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"guardian","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"totalAwarded","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"delegatorRewardsPerToken","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"stakingRewardsPerWeight","type":"uint256"}],"name":"GuardianStakingRewardsAssigned","type":"event"},{"anonymous":false,"inputs":[],"name":"InitializationComplete","type":"event"},{"anonymous":false,"inputs":[],"name":"Locked","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint32","name":"maxDelegatorsStakingRewardsPercentMille","type":"uint32"}],"name":"MaxDelegatorsStakingRewardsChanged","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousRegistryAdmin","type":"address"},{"indexed":true,"internalType":"address","name":"newRegistryAdmin","type":"address"}],"name":"RegistryManagementTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"startTime","type":"uint256"}],"name":"RewardDistributionActivated","type":"event"},{"anonymous":false,"inputs":[],"name":"RewardDistributionDeactivated","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"allocatedRewards","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"stakingRewardsPerWeight","type":"uint256"}],"name":"StakingRewardsAllocated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"addr","type":"address"},{"indexed":false,"internalType":"uint256","name":"guardianStakingRewards","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"delegatorStakingRewards","type":"uint256"},{"indexed":false,"internalType":"address","name":"toRewardsContract","type":"address"}],"name":"StakingRewardsBalanceMigrated","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"addr","type":"address"},{"indexed":false,"internalType":"uint256","name":"guardianStakingRewards","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"delegatorStakingRewards","type":"uint256"}],"name":"StakingRewardsBalanceMigrationAccepted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"addr","type":"address"},{"indexed":false,"internalType":"uint256","name":"claimedDelegatorRewards","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"claimedGuardianRewards","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"totalClaimedDelegatorRewards","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"totalClaimedGuardianRewards","type":"uint256"}],"name":"StakingRewardsClaimed","type":"event"},{"anonymous":false,"inputs":[],"name":"Unlocked","type":"event"},{"inputs":[{"internalType":"address","name":"addr","type":"address"},{"internalType":"uint256","name":"guardianStakingRewards","type":"uint256"},{"internalType":"uint256","name":"delegatorStakingRewards","type":"uint256"}],"name":"acceptRewardsBalanceMigration","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"startTime","type":"uint256"}],"name":"activateRewardDistribution","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"claimRegistryManagement","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"addr","type":"address"}],"name":"claimStakingRewards","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"guardian","type":"address"},{"internalType":"uint256","name":"weight","type":"uint256"},{"internalType":"uint256","name":"totalCommitteeWeight","type":"uint256"},{"internalType":"bool","name":"inCommittee","type":"bool"},{"internalType":"bool","name":"inCommitteeAfter","type":"bool"}],"name":"committeeMembershipWillChange","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"deactivateRewardDistribution","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"guardian","type":"address"},{"internalType":"uint256","name":"guardianDelegatedStake","type":"uint256"},{"internalType":"address","name":"delegator","type":"address"},{"internalType":"uint256","name":"delegatorStake","type":"uint256"},{"internalType":"address","name":"nextGuardian","type":"address"},{"internalType":"uint256","name":"nextGuardianDelegatedStake","type":"uint256"}],"name":"delegationWillChange","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"delegatorsStakingRewards","outputs":[{"internalType":"uint96","name":"balance","type":"uint96"},{"internalType":"uint96","name":"lastDelegatorRewardsPerToken","type":"uint96"},{"internalType":"uint96","name":"claimed","type":"uint96"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"emergencyWithdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"erc20","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getAnnualStakingRewardsCap","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getAnnualStakingRewardsRatePercentMille","outputs":[{"internalType":"uint32","name":"","type":"uint32"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getContractRegistry","outputs":[{"internalType":"contract IContractRegistry","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getCurrentStakingRewardsRatePercentMille","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"getDefaultDelegatorsStakingRewardsPercentMille","outputs":[{"internalType":"uint32","name":"","type":"uint32"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"delegator","type":"address"}],"name":"getDelegatorStakingRewardsData","outputs":[{"internalType":"uint256","name":"balance","type":"uint256"},{"internalType":"uint256","name":"claimed","type":"uint256"},{"internalType":"uint256","name":"lastDelegatorRewardsPerToken","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"guardian","type":"address"}],"name":"getGuardianDelegatorsStakingRewardsPercentMille","outputs":[{"internalType":"uint256","name":"delegatorRewardsRatioPercentMille","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"guardian","type":"address"}],"name":"getGuardianStakingRewardsData","outputs":[{"internalType":"uint256","name":"balance","type":"uint256"},{"internalType":"uint256","name":"claimed","type":"uint256"},{"internalType":"uint256","name":"delegatorRewardsPerToken","type":"uint256"},{"internalType":"uint256","name":"lastStakingRewardsPerWeight","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getMaxDelegatorsStakingRewardsPercentMille","outputs":[{"internalType":"uint32","name":"","type":"uint32"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getSettings","outputs":[{"internalType":"uint256","name":"annualStakingRewardsCap","type":"uint256"},{"internalType":"uint32","name":"annualStakingRewardsRatePercentMille","type":"uint32"},{"internalType":"uint32","name":"defaultDelegatorsStakingRewardsPercentMille","type":"uint32"},{"internalType":"uint32","name":"maxDelegatorsStakingRewardsPercentMille","type":"uint32"},{"internalType":"bool","name":"rewardAllocationActive","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"addr","type":"address"}],"name":"getStakingRewardsBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getStakingRewardsState","outputs":[{"internalType":"uint96","name":"stakingRewardsPerWeight","type":"uint96"},{"internalType":"uint96","name":"unclaimedStakingRewards","type":"uint96"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getStakingRewardsWalletAllocatedTokens","outputs":[{"internalType":"uint256","name":"allocated","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"guardiansRewardSettings","outputs":[{"internalType":"uint32","name":"delegatorsStakingRewardsPercentMille","type":"uint32"},{"internalType":"bool","name":"overrideDefault","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"guardiansStakingRewards","outputs":[{"internalType":"uint96","name":"delegatorRewardsPerToken","type":"uint96"},{"internalType":"uint96","name":"lastStakingRewardsPerWeight","type":"uint96"},{"internalType":"uint96","name":"balance","type":"uint96"},{"internalType":"uint96","name":"claimed","type":"uint96"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"initializationAdmin","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"initializationComplete","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"isInitializationComplete","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"isLocked","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"isRegistryAdmin","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"isRewardAllocationActive","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"lock","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"locked","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"addr","type":"address"}],"name":"migrateRewardsBalance","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"pendingRegistryAdmin","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"refreshContracts","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"registryAdmin","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"renounceRegistryManagement","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"annualRateInPercentMille","type":"uint256"},{"internalType":"uint256","name":"annualCap","type":"uint256"}],"name":"setAnnualStakingRewardsRate","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"contract IContractRegistry","name":"newContractRegistry","type":"address"}],"name":"setContractRegistry","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint32","name":"defaultDelegatorsStakingRewardsPercentMille","type":"uint32"}],"name":"setDefaultDelegatorsStakingRewardsPercentMille","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint32","name":"delegatorRewardsPercentMille","type":"uint32"}],"name":"setGuardianDelegatorsStakingRewardsPercentMille","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint32","name":"maxDelegatorsStakingRewardsPercentMille","type":"uint32"}],"name":"setMaxDelegatorsStakingRewardsPercentMille","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"stakingRewardsState","outputs":[{"internalType":"uint96","name":"stakingRewardsPerWeight","type":"uint96"},{"internalType":"uint96","name":"unclaimedStakingRewards","type":"uint96"},{"internalType":"uint32","name":"lastAssigned","type":"uint32"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"stakingRewardsWithdrawnFromWallet","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"newRegistryAdmin","type":"address"}],"name":"transferRegistryManagement","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"unlock","outputs":[],"stateMutability":"nonpayable","type":"function"}]
const OLD_FEES_AND_BOOTSTRAP_REWARDS_ABI = [{"inputs":[{"internalType":"contract IContractRegistry","name":"_contractRegistry","type":"address"},{"internalType":"address","name":"_registryAdmin","type":"address"},{"internalType":"contract IERC20","name":"_erc20","type":"address"},{"internalType":"contract IERC20","name":"_bootstrapToken","type":"address"},{"internalType":"uint256","name":"generalCommitteeAnnualBootstrap","type":"uint256"},{"internalType":"uint256","name":"certifiedCommitteeAnnualBootstrap","type":"uint256"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"guardian","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"BootstrapRewardsAssigned","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"guardian","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"BootstrapRewardsWithdrawn","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"certifiedCommitteeAnnualBootstrap","type":"uint256"}],"name":"CertifiedCommitteeAnnualBootstrapChanged","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"addr","type":"address"}],"name":"ContractRegistryAddressUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"addr","type":"address"}],"name":"EmergencyWithdrawal","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"guardian","type":"address"},{"indexed":false,"internalType":"uint256","name":"fees","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"bootstrapRewards","type":"uint256"},{"indexed":false,"internalType":"address","name":"toRewardsContract","type":"address"}],"name":"FeesAndBootstrapRewardsBalanceMigrated","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"guardian","type":"address"},{"indexed":false,"internalType":"uint256","name":"fees","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"bootstrapRewards","type":"uint256"}],"name":"FeesAndBootstrapRewardsBalanceMigrationAccepted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"guardian","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"FeesAssigned","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"guardian","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"FeesWithdrawn","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"generalCommitteeAnnualBootstrap","type":"uint256"}],"name":"GeneralCommitteeAnnualBootstrapChanged","type":"event"},{"anonymous":false,"inputs":[],"name":"InitializationComplete","type":"event"},{"anonymous":false,"inputs":[],"name":"Locked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousRegistryAdmin","type":"address"},{"indexed":true,"internalType":"address","name":"newRegistryAdmin","type":"address"}],"name":"RegistryManagementTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"startTime","type":"uint256"}],"name":"RewardDistributionActivated","type":"event"},{"anonymous":false,"inputs":[],"name":"RewardDistributionDeactivated","type":"event"},{"anonymous":false,"inputs":[],"name":"Unlocked","type":"event"},{"inputs":[{"internalType":"address","name":"guardian","type":"address"},{"internalType":"uint256","name":"fees","type":"uint256"},{"internalType":"uint256","name":"bootstrap","type":"uint256"}],"name":"acceptRewardsBalanceMigration","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"startTime","type":"uint256"}],"name":"activateRewardDistribution","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"bootstrapToken","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"claimRegistryManagement","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"guardian","type":"address"},{"internalType":"bool","name":"inCommittee","type":"bool"},{"internalType":"bool","name":"isCertified","type":"bool"},{"internalType":"bool","name":"nextCertification","type":"bool"},{"internalType":"uint256","name":"generalCommitteeSize","type":"uint256"},{"internalType":"uint256","name":"certifiedCommitteeSize","type":"uint256"}],"name":"committeeMembershipWillChange","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"deactivateRewardDistribution","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"emergencyWithdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"erc20","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"feesAndBootstrap","outputs":[{"internalType":"uint96","name":"feeBalance","type":"uint96"},{"internalType":"uint96","name":"lastFeesPerMember","type":"uint96"},{"internalType":"uint96","name":"bootstrapBalance","type":"uint96"},{"internalType":"uint96","name":"lastBootstrapPerMember","type":"uint96"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"feesAndBootstrapState","outputs":[{"internalType":"uint96","name":"certifiedFeesPerMember","type":"uint96"},{"internalType":"uint96","name":"generalFeesPerMember","type":"uint96"},{"internalType":"uint96","name":"certifiedBootstrapPerMember","type":"uint96"},{"internalType":"uint96","name":"generalBootstrapPerMember","type":"uint96"},{"internalType":"uint32","name":"lastAssigned","type":"uint32"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getCertifiedCommitteeAnnualBootstrap","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getContractRegistry","outputs":[{"internalType":"contract IContractRegistry","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"guardian","type":"address"}],"name":"getFeesAndBootstrapBalance","outputs":[{"internalType":"uint256","name":"feeBalance","type":"uint256"},{"internalType":"uint256","name":"bootstrapBalance","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"guardian","type":"address"}],"name":"getFeesAndBootstrapData","outputs":[{"internalType":"uint256","name":"feeBalance","type":"uint256"},{"internalType":"uint256","name":"lastFeesPerMember","type":"uint256"},{"internalType":"uint256","name":"bootstrapBalance","type":"uint256"},{"internalType":"uint256","name":"lastBootstrapPerMember","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getFeesAndBootstrapState","outputs":[{"internalType":"uint256","name":"certifiedFeesPerMember","type":"uint256"},{"internalType":"uint256","name":"generalFeesPerMember","type":"uint256"},{"internalType":"uint256","name":"certifiedBootstrapPerMember","type":"uint256"},{"internalType":"uint256","name":"generalBootstrapPerMember","type":"uint256"},{"internalType":"uint256","name":"lastAssigned","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getGeneralCommitteeAnnualBootstrap","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getSettings","outputs":[{"internalType":"uint256","name":"generalCommitteeAnnualBootstrap","type":"uint256"},{"internalType":"uint256","name":"certifiedCommitteeAnnualBootstrap","type":"uint256"},{"internalType":"bool","name":"rewardAllocationActive","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"initializationAdmin","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"initializationComplete","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"isInitializationComplete","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"isLocked","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"isRegistryAdmin","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"isRewardAllocationActive","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"lock","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"locked","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"guardian","type":"address"}],"name":"migrateRewardsBalance","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"pendingRegistryAdmin","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"refreshContracts","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"registryAdmin","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"renounceRegistryManagement","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"annualAmount","type":"uint256"}],"name":"setCertifiedCommitteeAnnualBootstrap","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"contract IContractRegistry","name":"newContractRegistry","type":"address"}],"name":"setContractRegistry","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"annualAmount","type":"uint256"}],"name":"setGeneralCommitteeAnnualBootstrap","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newRegistryAdmin","type":"address"}],"name":"transferRegistryManagement","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"unlock","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"guardian","type":"address"}],"name":"withdrawBootstrapFunds","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"guardian","type":"address"}],"name":"withdrawFees","outputs":[],"stateMutability":"nonpayable","type":"function"}]

export async function listPastGuardians(guardianRegistrationContractAddr: string): Promise<string[]> {
    const web3 = new Web3(new Web3.providers.HttpProvider("https://mainnet.infura.io/v3/62f4815d28674debbe4703c5eb9d413c"))
    const contract = new web3.eth.Contract(require("@orbs-network/orbs-ethereum-contracts-v2/release/build/contracts/GuardiansRegistration.json").abi, guardianRegistrationContractAddr);
    const events = await contract.getPastEvents("GuardianDataUpdated", {
        fromBlock: "earliest",
        toBlock: "latest",
    });
    let guardians: string[] = [];
    for (const e of events) {
        const guardian = e.returnValues.guardian;
        guardians = guardians.filter(g => g != guardian).concat([guardian]);
    }

    return guardians;
}

async function listDelegators(delegationsAddr: string): Promise<string[]> {
    const web3 = new Web3(new Web3.providers.HttpProvider("https://mainnet.infura.io/v3/62f4815d28674debbe4703c5eb9d413c"));
    const contract = new web3.eth.Contract(require("@orbs-network/orbs-ethereum-contracts-v2/release/build/contracts/Delegations.json").abi, delegationsAddr);
    const events = await contract.getPastEvents("Delegated", {
        fromBlock: "earliest",
        toBlock: "latest",
    });
    let delegators: string[] = [];
    for (const e of events) {
        delegators = delegators.filter(addr => addr != e.returnValues.from).concat([e.returnValues.from]);
    }

    return delegators;
}

compiledContracts['StakingRewards'].abi = OLD_STAKING_REWARDS_ABI;
compiledContracts['FeesAndBootstrapRewards'].abi = OLD_FEES_AND_BOOTSTRAP_REWARDS_ABI;

export async function migrateRewardBalances(web3?: Web3Driver) {
    web3 = web3 || new Web3Driver();

    const contractRegistry: ContractRegistryContract = web3.getExisting('ContractRegistry', CONTRACT_REGISTRY_ADDR);

    console.log(`Previous stakingRewards contract: ${OLD_STAKING_REWARDS_ADDR}`);
    const oldStakingRewardsContract = web3.getExisting('StakingRewards', OLD_STAKING_REWARDS_ADDR, undefined, OLD_STAKING_REWARDS_ABI);

    console.log(`Previous feesAndBootstrapRewards contract: ${OLD_FEES_AND_BOOTSTRAP_REWARDS_ADDR}`);
    const oldFeesAndBootstrapRewardsContract = web3.getExisting('FeesAndBootstrapRewards', OLD_FEES_AND_BOOTSTRAP_REWARDS_ADDR, undefined, OLD_FEES_AND_BOOTSTRAP_REWARDS_ABI);

    const delegationsContractAddr = await contractRegistry.getContract("delegations");
    console.log(`Delegations contract: ${delegationsContractAddr}`);

    if (readline.question('continue? [yes/no]') != 'yes') {
        throw new Error("aborted by user");
    }

    console.log("listing guardians...");
    const pastGuardians = await listPastGuardians(await contractRegistry.getContract('guardiansRegistration'));

    console.log("listing delegators...");
    const allDelegators = (await listDelegators(delegationsContractAddr)).concat(pastGuardians);

    console.log(`filtering delegators with no staking rewards balance out of ${allDelegators.length} `);
    const delegatorsToMigrate: string[] = [];
    for (const chunk of _.chunk(allDelegators, 20)) {
        await Promise.all(chunk.map(async(d) => {
            const balance = await oldStakingRewardsContract.getStakingRewardsBalance(d);
            if (bn(balance).gt(bn(0))) {
                delegatorsToMigrate.push(d);
            }
        }));
    }

    console.log("filtering guardians with no fee/bootstrap rewards balance");
    const guardiansToMigrate: string[] = [];
    for (const chunk of _.chunk(pastGuardians, 10)) {
        await Promise.all(chunk.map(async(g) => {
            const balance = await oldFeesAndBootstrapRewardsContract.getFeesAndBootstrapBalance(g);
            if (bn(balance.feeBalance).gt(bn(0)) || bn(balance.bootstrapBalance).gt(bn(0))) {
                guardiansToMigrate.push(g);
            }
        }));
    }

    console.log(`Will migrate fees/bootstrap for the following ${guardiansToMigrate.length} guardians:`);
    for (const guardian of guardiansToMigrate) {
        console.log(guardian);
    }
    console.log('');

    console.log(`Will migrate staking reward for the following ${delegatorsToMigrate.length} delegators/guardians:`);
    for (const d of delegatorsToMigrate) {
        console.log(d);
    }
    console.log('');

    if (readline.question('continue? [yes/no]') != 'yes') {
        throw new Error("aborted by user");
    }

    console.log('Migrating staking rewards balances');
    for (const chunk of _.chunk(delegatorsToMigrate, 10)) {
        await Promise.all(chunk.map(async(d) => {
            await oldStakingRewardsContract.migrateRewardsBalance(d);
        }));
    }

    console.log('Migrating fees/boootstrap balances');
    for (const chunk of _.chunk(guardiansToMigrate, 10)) {
        await Promise.all(chunk.map(async(g) => {
            await oldFeesAndBootstrapRewardsContract.migrateRewardsBalance(g);
        }));
    }

    console.log('Migration completed.');

    console.log('Updating protocol wallets clients..')
    const stakingRewardsWalletAddr = await contractRegistry.getContract('stakingRewardsWallet');
    const bootstrapRewardsWalletAddr = await contractRegistry.getContract('bootstrapRewardsWallet');
    const stakingRewardsAddr = await contractRegistry.getContract('stakingRewards');
    const feesAndBootstrapRewardsAddr = await contractRegistry.getContract('feesAndBootstrapRewards');

    console.log('stakingRewardsWalletAddr:', stakingRewardsWalletAddr);
    console.log('bootstrapRewardsWalletAddr:', bootstrapRewardsWalletAddr);
    console.log('stakingRewardsAddr', stakingRewardsAddr);
    console.log('feesAndBootstrapRewardsAddr', feesAndBootstrapRewardsAddr);

    if (readline.question('continue? [yes/no]') != 'yes') {
        throw new Error("aborted by user");
    }

    const stakingRewardsWalletContract: ProtocolWalletContract = web3.getExisting("ProtocolWallet", stakingRewardsWalletAddr);
    await stakingRewardsWalletContract.setClient(stakingRewardsAddr);
    const bootstrapRewardsWalletContract: ProtocolWalletContract = web3.getExisting("ProtocolWallet", bootstrapRewardsWalletAddr);
    await bootstrapRewardsWalletContract.setClient(feesAndBootstrapRewardsAddr);
}

migrateRewardBalances().then(
    () => {
        console.log('Done');
        process.exit(0);
    }
,   (e) => {
        console.error(e);
        process.exit(1);
    }
);